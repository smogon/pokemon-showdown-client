#!/usr/bin/env node
'use strict';

const fs = require('fs');
const path = require('path');

const rootDir = path.resolve(__dirname, '..');
const spritesDir = path.join(rootDir, 'play.pokemonshowdown.com/sprites/trainers');
const outputDir = path.join(rootDir, 'play.pokemonshowdown.com/data');
const srcDir = path.join(rootDir, 'play.pokemonshowdown.com/src');

const AVATAR_WIDTH = 80;
const AVATAR_HEIGHT = 80;
const COLUMNS = 16;

function parseCreditedSprites(indexPath) {
	const content = fs.readFileSync(indexPath, 'utf8');
	const matches = content.match(/"([a-zA-Z0-9_-]+)\.png"/g) || [];
	const sprites = new Set();

	for (const match of matches) {
		const name = match.replace(/"/g, '').replace('.png', '');
		sprites.add(name);
	}

	return Array.from(sprites).sort();
}

function getExistingAvatarNumbers(srcPath) {
	const dexDataPath = path.join(srcPath, 'battle-dex-data.ts');
	const content = fs.readFileSync(dexDataPath, 'utf8');

	const startIdx = content.indexOf('export const BattleAvatarNumbers');
	if (startIdx === -1) return {};

	let braceStart = content.indexOf('{', startIdx);
	if (braceStart === -1) return {};
	braceStart = content.indexOf('{', braceStart + 1);
	if (braceStart === -1) return {};

	let depth = 0;
	let braceEnd = -1;
	for (let i = braceStart; i < content.length; i++) {
		if (content[i] === '{') depth++;
		if (content[i] === '}') depth--;
		if (depth === 0) {
			braceEnd = i;
			break;
		}
	}
	if (braceEnd === -1) return {};

	const objContent = content.slice(braceStart + 1, braceEnd);
	const entries = {};

	const numRegex = /(\d+):\s*'([^']+)'/g;
	let m;
	while ((m = numRegex.exec(objContent)) !== null) {
		entries[m[1]] = m[2];
	}

	const strRegex = /'([^']+)':\s*'([^']+)'/g;
	while ((m = strRegex.exec(objContent)) !== null) {
		entries[m[1]] = m[2];
	}

	return entries;
}

function buildAvatarList(creditedSprites, existingNumbers) {
	const avatars = [];
	const seen = new Set();

	for (let i = 1; i <= 293; i++) {
		if (i === 162 || i === 168) continue;
		const name = existingNumbers[i] || `${i}`;
		if (!seen.has(name)) {
			avatars.push({
				id: name,
				num: i,
				category: 'default',
			});
			seen.add(name);
		}
	}

	for (const name of creditedSprites) {
		if (!seen.has(name)) {
			avatars.push({
				id: name,
				num: null,
				category: 'extra',
			});
			seen.add(name);
		}
	}

	return avatars;
}

function generateManifest(avatars) {
	const manifest = {
		version: 1,
		avatarWidth: AVATAR_WIDTH,
		avatarHeight: AVATAR_HEIGHT,
		columns: COLUMNS,
		generated: new Date().toISOString(),
		avatars: [],
	};

	const defaultAvatars = avatars.filter(a => a.category === 'default');
	const extraAvatars = avatars.filter(a => a.category === 'extra');

	for (const avatar of defaultAvatars) {
		const col = (avatar.num - 1) % COLUMNS;
		const row = Math.floor((avatar.num - 1) / COLUMNS);
		manifest.avatars.push({
			id: avatar.id,
			num: avatar.num,
			sheet: 'trainers-sheet',
			x: col * AVATAR_WIDTH,
			y: row * AVATAR_HEIGHT,
			category: 'default',
		});
	}

	for (const avatar of extraAvatars) {
		manifest.avatars.push({
			id: avatar.id,
			num: null,
			sheet: null,
			category: 'extra',
		});
	}

	return manifest;
}

function generateTsData(manifest) {
	const lines = [
		'// auto-generated by build-tools/build-trainers',
		'',
		'export interface TrainerAvatarData {',
		'\tid: string;',
		'\tnum: number | null;',
		'\tsheet: string | null;',
		'\tx?: number;',
		'\ty?: number;',
		'\tcategory: "default" | "extra";',
		'}',
		'',
		'export const TrainerAvatarManifest = {',
		`\tversion: ${manifest.version},`,
		`\tavatarWidth: ${manifest.avatarWidth},`,
		`\tavatarHeight: ${manifest.avatarHeight},`,
		`\tcolumns: ${manifest.columns},`,
		`\tgenerated: "${manifest.generated}",`,
		`\tcount: ${manifest.avatars.length},`,
		`\tdefaultCount: ${manifest.avatars.filter(a => a.category === 'default').length},`,
		`\textraCount: ${manifest.avatars.filter(a => a.category === 'extra').length},`,
		'} as const;',
		'',
		'export const TrainerAvatars: TrainerAvatarData[] = [',
	];

	for (const avatar of manifest.avatars) {
		if (avatar.sheet) {
			lines.push(`\t{ id: "${avatar.id}", num: ${avatar.num}, sheet: "${avatar.sheet}", x: ${avatar.x}, y: ${avatar.y}, category: "${avatar.category}" },`);
		} else {
			lines.push(`\t{ id: "${avatar.id}", num: null, sheet: null, category: "${avatar.category}" },`);
		}
	}

	lines.push('];');
	lines.push('');

	return lines.join('\n');
}

function main() {
	console.log('Building trainer avatar manifest...');

	const indexPath = path.join(spritesDir, 'index.php');
	if (!fs.existsSync(indexPath)) {
		console.error('Error: sprites/trainers/index.php not found');
		process.exit(1);
	}

	const creditedSprites = parseCreditedSprites(indexPath);
	console.log(`Found ${creditedSprites.length} credited sprites`);

	const existingNumbers = getExistingAvatarNumbers(srcDir);
	console.log(`Found ${Object.keys(existingNumbers).length} existing avatar mappings`);

	const avatars = buildAvatarList(creditedSprites, existingNumbers);
	console.log(`Total avatars: ${avatars.length}`);

	const manifest = generateManifest(avatars);

	const MIN_AVATARS = 500;
	if (manifest.avatars.length < MIN_AVATARS) {
		console.error(`Error: expected at least ${MIN_AVATARS} avatars, got ${manifest.avatars.length}`);
		process.exit(1);
	}

	const defaultCount = manifest.avatars.filter(a => a.category === 'default').length;
	if (defaultCount < 290) {
		console.error(`Error: expected at least 290 default avatars, got ${defaultCount}`);
		process.exit(1);
	}

	if (!fs.existsSync(outputDir)) {
		fs.mkdirSync(outputDir, { recursive: true });
	}

	const jsonPath = path.join(outputDir, 'trainers-manifest.json');
	fs.writeFileSync(jsonPath, JSON.stringify(manifest, null, 2));
	console.log(`Written: ${jsonPath}`);

	const tsPath = path.join(srcDir, 'trainer-avatars.ts');
	fs.writeFileSync(tsPath, generateTsData(manifest));
	console.log(`Written: ${tsPath}`);

	console.log('Done!');
}

main();
